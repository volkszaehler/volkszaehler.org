language: php
php:
- 7.0
- 7.1
- 7.2
- 7.3
services:
- mysql
sudo: false
env:
  global:
  - DEPENDENCIES=standard
  - TRAVIS_TEST_EXCLUDES="--exclude-group slow,jpgraph,pushserver"
  - COMMIT=${TRAVIS_COMMIT::8}
  matrix:
  - DB=mysql
  - secure: JxyXH2fb2l7uWsZxe23rSxYYvylu/DRm9bV6gaowxvmXzqLzEtIsI1aOeP4gJiZGOOUzlCsOhNgKs/bFJsn2SRe0IE60w+eZ3kOxfBfqbr4yop5qYL5YNWJX25LeshBBJLi6vTsEJiLNRuFFZrynNcU+Q2GxrZ+HNi7Tn4KCD523wwKDGdf4sEc+0GRPVMJB2FBxHrVIVRolxISGRVV67owEuiN2COzk8vnt5q6SH692CWZJPvnIDeassPOMALNNPG8sjsWfBim5+2pemHopnnk6dSLlyIO2s3uHnlF7z+5P2/V8xxRfTEHbgMu1p23NYUjyTbGPA4H6bfL5bHjcHm8KsruIxKrsXkTNs0o8ltiqpYhDvDVdHgO7KLwMeaA38ZmX6UBVHrgsW46tp7w0wFlYY6yti0bOKLIbH2JK+GFH3+vUpGSM2uQPvWnPG77mQO5eNKQ/IxDMdRVgZUr11FfaRjPJ3KVOaWF9pc3irnVCkO1ssHpUdnJnJ0hqXT9isZBcoVXBt0oUFRtkeolt5kG3Q/R7189GfezIi1qOSNY/+So845f5ota2Q+GNYb2qUgT8Hh+C8OPWXBrReoJ0nCaF305q0pCbcHJjA9QwO4WKe8RZLnODeOvwjquqnPQ5I+c4aVwvucheaMMiTTLRTBqRxXgY83/83Vc+a219wP8=
  - secure: S+sP0mQ06XZilxkSkqZIns0OKe7JlThLQfAoYqY87D3vyYQT8PVMslbHTQxrun+Sx2lQvP6x76JpBP3e5aDgd29qXONg8LeI68CnDxJ2rijJzZ2qSAagHOXaTDjUIP+1SdZkmDiv7rodAJbcD8WkqwtPnEfX64WbkScLJk0ZFc8UjJHkGqlXqLJGbGMygETGEjeqAh5mzeRq6AXAnPPRwRcYP0J9Z7B95rpaSNNvrKkodvXdnCaqJaSOQ3BiP9K+5uIja1S+4jucJAX17M0T57pgFbMBv9+XmtQfOqTeqkjRXABp2E5K8f52/afILm1Db5EMQ9K9PW6VnImk05a6Fn1YT7ccLQnvScIuRXWd0/liRrl5dIm0R71l6U3KhflsZjrg7vHV4aK/6YtlwF0vgXqtw3VkeCVKmICY01VjGgVSxUKnXbTmFrL640FDlPSPD9X+NVgb6ZzNv3hOFC+xhDR1k8yU8m1WtBr25o2enYKSJTGW8kNIlFbGnCp5MKVrmKuGk1PLA6UDZt9AiSsSLKJ/S9MlOapq4OIO+imf9EhnImpbT9f9fAc5d1UE6B/8ix/DLKDzuHV4n/oDz0kfELwV+GZwx4GkEjq+r/Yuld8dL+0Af1T2NDYA2rEjiuBwyb3sKADRHJuWWT1O64E+wqV1/87KvIdlBkBKbs9PCVs=
  - secure: E7gyzr0oLW2G77r5u4g2XXOdwpMowb9jQSMg7FhoLKnPKmud2apl11NpAxSzR6j8pekuOx9IWYKS79ht1WH2lw2BR43egM4sJjbrkTSHUZVRgR7W+Dzy64B4BqIt67661DqbdS4BlYluvCA02YH7mLhzJyhzNRXXTzW7Ul3Z4eSgn4ftqyYmrFKOIA4TizVQkN+OXBCHhWK5cu0qFFTyg+ya5/hG8lvIzMSPZq9MaUDYebzLhd5CqVi9JN4L/FxDjMfp48RwYnPJE9z7vaHEpCgnxnFoPjG89I1phXczNYq2jDXIlPQCeBT5fVHzi5iHyzgj0q/lHBYBNFcmeNUvOCH64lIBIfGmRzjjACAX+vpzT/fchkj44+EDCHb6Puuc/kNcrOBX0kHZfpA985zccUeA9VCQd2Wx74ncoTplbaCjg6quzIXIJYoz6/kwaoYuTXRg5mBwoMNQXvhFy33buUxXNoxjKSUVEoOuNajYDOqNg+PrdBabV2/uWN0dOD/70EPLiJ6c3yJaTzSkYuXm4l38RRzCIB8HaDFcwTweWQ+LzP90pvH9Xt8aUqz//Y7o0OwqR/SRXeoCBcUhn9oGLapzeOISKsZtyz75DpHktsb2OV8I6h6qoGojlTJ9tW2n9M3ES/W958Fk84hdYuper5cLLCG39HYby7cwgs/bI74=
  - secure: JvKb6PpwuTQ3dznzZQnb2Q0vIYWXo+QAtCUTghEREhSsgFeMKroYEHAspRvcasS5f2lJDmyM5l36hEW5AgKOTojJjJ/+vC93p0FjBGZhrRiGavZkTAGkmjo3VJTS3JM7uOLBleAKkcBtDMpYGkWpSCDrk/3D36aLRNn9bZ6322Jvlq/Mbq78YTJ3uc3ydFCj5+SdYEifU0aQzpwQeq44WYhAiOYc/YOHx/YFOuwYZZGK5cuNgHcG4jGxwYpCrO0VgHgeeJr+RJQPsVfOk/FeJKdjdZzI+jEFLQq31b7u+y4LyFwd+uB/zW5G7xAtnVtm8ltzZpCwa8gFM2YmxD/xVzTtbx/OviSa2jI+KIPyx+7lxX6Z3cKTgMRzn+ynrK2Wn+Ztn3uzJ49d1Ysg+sL8WPpmDA5sk1G/BGrm/9vGzqW0thJTASvt/BVMPgZAFqr57XP0Sz7hjSZ1MF1f/BZ5K/pDC7os0tkoWMTHxGCSTXlkCwl/F1HZHsIl+MLEuF4yw+dbwqIOMEb1G6u9vCcTQ1nSHmDxPVcR54XJiheS4FEU+zs4Igsn9r+RXlt2f/iAJFyl0R/92OimzGecjHZ5eohbnDYcxY4G5tDVm9WTAetB6jlMKLfYNR9T1kXO0V4WIh5ZkwMwB5Xlum54CLT5OmZBbmLWIE0J5mD5RYwZe50=
matrix:
  include:
  - php: 7.0
    services: postresql
    env: DB=pgsql
  - php: 7.0
    env: DB=sqlite
  - php: 7.0
    env: DB=mysql COMPONENT=HTTPD
  - php: 7.0
    env: DB=mysql COMPONENT=PUSHD
  - php: 7.0
    env: DB=mysql COMPONENT=DOCKER
  - php: 7.0
    env: DB=mysql DEPENDENCIES=lowest
  - php: 7.0
    env: DB= DEPENDENCIES= JSLINT=true
notifications:
  email: volkszaehler-dev@lists.volkszaehler.org
  irc: chat.freenode.net#volkszaehler.org
cache:
  directories:
  - "$COMPOSER_CACHE_DIR"
  - "$HOME/.composer/cache"
  - node_modules
before_install:
- if [ -e /home/travis/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini
  ]; then rm /home/travis/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini;
  fi
install:
- if [ "$JSLINT" = true ]; then npm install -g gulp; npm install; fi
- if [ "$DEPENDENCIES" = "standard" ]; then composer install; fi
- if [ "$DEPENDENCIES" = "lowest" ]; then composer update --prefer-lowest -n; fi
- |
  if [ "$JSLINT" != true ]; then
    phpenv config-add ./test/bin/apc.ini && printf "\n" | pecl install apcu
    php -r 'echo(function_exists("apcu_store")?"APCu enabled":"APCu disabled");'
  fi
before_script:
- set -e
- cp etc/volkszaehler.conf.template.php etc/volkszaehler.conf.php
- DATABASE=volkszaehler
- USER=root
- PASSWORD=
- if [ "$DB" = "pgsql" ]; then USER=postgres; fi
- sed -i "s/'pdo_mysql'/'pdo_$DB'/" etc/volkszaehler.conf.php
- sed -i "s/'vz'/'$USER'/" etc/volkszaehler.conf.php
- sed -i "s/'demo'/'$PASSWORD'/" etc/volkszaehler.conf.php
- sed -i "s/'volkszaehler'/'$DATABASE'/" etc/volkszaehler.conf.php
- if [ "$DB" = "sqlite" ]; then sed -i "s/\?>/\$config['db']['path']\ =\ VZ_DIR.'\/sqlite.db3'\;\n?>/"
  etc/volkszaehler.conf.php; fi
- cat etc/volkszaehler.conf.php
- if [ "$DB" = "mysql" ]; then mysql -e "CREATE DATABASE $DATABASE;" -u $USER; fi
- if [ "$DB" = "pgsql" ]; then psql -c "CREATE DATABASE $DATABASE;" -U $USER; fi
- if [ -n "$DB" ]; then php bin/doctrine orm:schema-tool:create; fi
- |
  if [ "$COMPONENT" = "HTTPD" ]; then
    sed -i "s/testAdapter\" value=\".*\"/testAdapter\" value=\"HTTP\"/" phpunit.xml
    vendor/bin/ppm start -c etc/middleware.json &
  fi
- |
  if [ "$COMPONENT" = "PUSHD" ]; then
    sed -i "s/\?>/\$config['push']['enabled']\ =\ true\;\n?>/" etc/volkszaehler.conf.php
    php bin/push-server &
  fi
after_script:
- |
  if [ "$COMPONENT" = "HTTPD" ]; then
    vendor/bin/ppm stop -c etc/middleware.json
  fi
script:
- if [ -n "$DB" ]; then vendor/bin/phpunit $TRAVIS_TEST_EXCLUDES,aggregation; fi
- |
  if [ "$DB" = "mysql" ]; then
    sed -i "s/\?>/\$config['aggregation']\ =\ true;\n?>/" etc/volkszaehler.conf.php
    php bin/aggregate run -m delta -l hour
    vendor/bin/phpunit $TRAVIS_TEST_EXCLUDES
  fi
- if [ "$COMPONENT" = "PUSHD" ]; then vendor/bin/phpunit --group pushserver; fi
- if [ "$JSLINT" = true ]; then gulp jshint; fi
after_success:
- echo $DOCKER_USER
- echo $DOCKER_PASSWORD
- echo $SOME_OTHER_VARIABLE
- echo $YET_OTHER_VARIABLE
- echo $TEST_VAR
- echo $TEST_VAR_2
- |
  if [ "$COMPONENT" == "DOCKER" ] && [ "$TRAVIS_BRANCH" == "master" ] && [ "$DOCKER_USER" != "" ]; then
    docker login -u $DOCKER_USER -p $DOCKER_PASS
    export REPO=volkszaehler/volkszaehler
    docker pull $REPO:latest
    docker build --cache-from $REPO:latest -f Dockerfile -t $REPO:$COMMIT .
    docker tag $REPO:$COMMIT $REPO:latest
    docker push $REPO
  fi
